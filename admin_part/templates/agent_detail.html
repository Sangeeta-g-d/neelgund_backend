{% extends 'admin_base.html' %}
{% load static %}
{% block content %}
<div class="container py-4">

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h3 class="fw-bold text-dark mb-0">Agent Details</h3>
    <a href="{% url 'agents_list' %}" class="btn btn-outline-secondary rounded-3">
      <i class="bi bi-arrow-left me-2"></i> Back to Agents
    </a>
  </div>

  <!-- Main Content Row -->
  <div class="row g-4">
    
    <!-- Left Column - Agent Profile & Stats -->
    <div class="col-lg-4">
      
      <!-- Agent Profile Card -->
      <div class="card border-0 shadow-lg rounded-4 mb-4">
        <div class="card-body p-4">
          <!-- Profile Header -->
          <div class="text-center mb-4">
            {% if agent.profile_image %}
              <img src="{{ agent.profile_image.url }}" class="rounded-circle border shadow-sm mb-3" width="120" height="120" style="object-fit: cover;">
            {% else %}
              <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center mx-auto mb-3 shadow"
                   style="width: 120px; height: 120px; font-size: 2.5rem;">
                {{ agent.full_name|first|upper }}
              </div>
            {% endif %}
            <h4 class="fw-bold mb-2 text-dark">{{ agent.full_name }}</h4>
            <p class="text-muted mb-3">Agent ID: AG-{{ agent.id|stringformat:"06d" }}</p>
          </div>

          <!-- Contact Info -->
          <div class="mb-4">
            <h6 class="fw-semibold mb-3 text-dark border-bottom pb-2">Contact Information</h6>
            <div class="d-flex align-items-center mb-3">
              <div class="icon-wrapper bg-primary bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                <i class="bi bi-telephone text-primary"></i>
              </div>
              <div>
                <span class="text-muted small d-block">Phone</span>
                <span class="fw-semibold">{{ agent.phone_number|default:"Not provided" }}</span>
              </div>
            </div>
            <div class="d-flex align-items-center">
              <div class="icon-wrapper bg-primary bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                <i class="bi bi-envelope text-primary"></i>
              </div>
              <div>
                <span class="text-muted small d-block">Email</span>
                <span class="fw-semibold">{{ agent.email }}</span>
              </div>
            </div>
          </div>

          <hr class="my-4">

          <!-- Professional Details -->
          <div class="mb-4">
            <h6 class="fw-semibold mb-3 text-dark border-bottom pb-2">Professional Details</h6>
            <div class="d-flex justify-content-between align-items-center mb-3">
              <span class="text-muted">Joined Date:</span>
              <span class="fw-semibold">{{ agent.date_joined|date:"M d, Y" }}</span>
            </div>
            <div class="d-flex justify-content-between align-items-center mb-3">
              <span class="text-muted">DOB:</span>
              <span class="fw-semibold">{{ agent.dob|date:"Y-m-d"|default:"Not provided" }}</span>
            </div>
            <div class="d-flex justify-content-between align-items-center">
              <span class="text-muted">Status:</span>
              <span id="statusBadge" class="badge {% if agent.approved %}bg-success{% else %}bg-danger{% endif %} rounded-pill px-3 py-2">
                {% if agent.approved %}Active{% else %}Deactivated{% endif %}
              </span>
            </div>
          </div>

          <hr class="my-4">

          <!-- Status Toggle -->
          <div class="text-center">
            {% if agent.approved %}
              <button id="deactivateBtn" class="btn btn-outline-danger rounded-3 w-100 py-2">
                <i class="bi bi-person-x me-2"></i>Deactivate Agent
              </button>
            {% else %}
              <button id="activateBtn" class="btn btn-outline-success rounded-3 w-100 py-2">
                <i class="bi bi-person-check me-2"></i>Activate Agent
              </button>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Performance Stats -->
      <div class="card border-0 shadow-lg rounded-4">
        <div class="card-body p-4">
          <h6 class="fw-semibold mb-4 text-dark border-bottom pb-2">Performance Overview</h6>
          
          <!-- Total Leads -->
          <div class="d-flex align-items-center justify-content-between mb-4 p-3 rounded-3" style="background-color: #f8f9fa;">
            <div>
              <h3 class="fw-bold text-primary mb-1">{{ total_leads }}</h3>
              <span class="text-muted small">Total Leads</span>
            </div>
            <div class="icon-wrapper bg-primary bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center shadow-sm" style="width: 50px; height: 50px;">
              <i class="bi bi-people text-primary fs-5"></i>
            </div>
          </div>

          <!-- Deals Closed -->
          <div class="d-flex align-items-center justify-content-between mb-4 p-3 rounded-3" style="background-color: #f8f9fa;">
            <div>
              <h3 class="fw-bold text-success mb-1">{{ closed_deals }}</h3>
              <span class="text-muted small">Deals Closed</span>
            </div>
            <div class="icon-wrapper bg-success bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center shadow-sm" style="width: 50px; height: 50px;">
              <i class="bi bi-check-circle text-success fs-5"></i>
            </div>
          </div>

          <!-- Commission -->
          <div class="d-flex align-items-center justify-content-between p-3 rounded-3" style="background-color: #f8f9fa;">
            <div>
              <h3 class="fw-bold text-info mb-1">₹{{ total_commission|floatformat:0|default:"0" }}</h3>
              <span class="text-muted small">Total Commission</span>
            </div>
            <div class="icon-wrapper bg-info bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center shadow-sm" style="width: 50px; height: 50px;">
              <i class="bi bi-currency-rupee text-info fs-5"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Column - Leads & Withdrawals -->
    <div class="col-lg-8">
      
      <!-- Tabs Navigation -->
      <div class="card border-0 shadow-sm rounded-4 mb-4">
        <div class="card-body p-0">
          <ul class="nav nav-tabs nav-justified" id="agentTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active py-3" id="leads-tab" data-bs-toggle="tab" data-bs-target="#leads" type="button" role="tab">
                <i class="bi bi-people me-2"></i>Leads Details
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link py-3" id="withdraw-tab" data-bs-toggle="tab" data-bs-target="#withdraw" type="button" role="tab">
                <i class="bi bi-cash-coin me-2"></i>Withdraw Requests
              </button>
            </li>
          </ul>
        </div>
      </div>

      <!-- Tab Content -->
      <div class="tab-content" id="agentTabsContent">
        
        <!-- Leads Tab -->
        <div class="tab-pane fade show active" id="leads" role="tabpanel">
          
          <!-- Lead Status Breakdown -->
          <div class="card border-0 shadow-sm rounded-4 mb-4">
            <div class="card-body p-4">
              <h6 class="fw-semibold mb-4 text-dark">Lead Status Breakdown</h6>
              <div class="row g-3">
                <div class="col-6 col-md-3">
                  <div class="text-center p-3 rounded-3 shadow-sm border" style="background-color: #e8f0fe;">
                    <h4 class="fw-bold text-primary mb-1">{{ leads_new }}</h4>
                    <span class="text-muted small">New</span>
                  </div>
                </div>
                <div class="col-6 col-md-3">
                  <div class="text-center p-3 rounded-3 shadow-sm border" style="background-color: #e6f7ff;">
                    <h4 class="fw-bold text-info mb-1">{{ leads_in_progress }}</h4>
                    <span class="text-muted small">In Progress</span>
                  </div>
                </div>
                <div class="col-6 col-md-3">
                  <div class="text-center p-3 rounded-3 shadow-sm border" style="background-color: #e8f8f0;">
                    <h4 class="fw-bold text-success mb-1">{{ closed_deals }}</h4>
                    <span class="text-muted small">Closed</span>
                  </div>
                </div>
                <div class="col-6 col-md-3">
                  <div class="text-center p-3 rounded-3 shadow-sm border" style="background-color: #fff8e1;">
                    <h4 class="fw-bold text-warning mb-1">{{ leads_cancelled }}</h4>
                    <span class="text-muted small">Cancelled</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Recent Leads -->
          <div class="card border-0 shadow-sm rounded-4">
            <div class="card-header bg-transparent border-0 py-3 px-4">
              <h6 class="fw-semibold mb-0 text-dark">Recent Leads</h6>
            </div>
            <div class="card-body p-0">
              <div class="leads-container" style="max-height: 780px; overflow-y: auto;">
                {% for lead in recent_leads %}
                <div class="border-bottom p-4 {% if forloop.last %}border-bottom-0{% endif %} lead-item">
                  <div class="d-flex justify-content-between align-items-start mb-2">
                    <div class="flex-grow-1">
                      <h6 class="fw-semibold mb-1 text-primary">#LD-{{ lead.id|stringformat:"03d" }}</h6>
                      <h5 class="fw-bold text-dark mb-1">{{ lead.full_name }}</h5>
                      <p class="text-muted mb-2">
                        <i class="bi bi-telephone me-1"></i>{{ lead.contact_number }}
                        {% if lead.email %}
                          <span class="ms-3"><i class="bi bi-envelope me-1"></i>{{ lead.email }}</span>
                        {% endif %}
                      </p>
                      {% if lead.preferred_location %}
                      <p class="text-muted mb-0">
                        <i class="bi bi-geo-alt me-1"></i>{{ lead.preferred_location }}
                      </p>
                      {% endif %}
                    </div>
                    <div class="text-end ms-3">
                      <span class="badge 
                        {% if lead.status == 'closed' %}bg-success
                        {% elif lead.status == 'in_progress' %}bg-info
                        {% elif lead.status == 'cancelled' %}bg-warning
                        {% else %}bg-secondary{% endif %} 
                        rounded-pill px-3 py-2 mb-2 d-inline-block">
                        {{ lead.get_status_display }}
                      </span>
                      <p class="text-muted small mb-0">{{ lead.created_at|date:"M d, Y" }}</p>
                    </div>
                  </div>
                  
                  <!-- Project Interests -->
                  {% if lead.projects.exists %}
                  <div class="mt-3">
                    <span class="text-muted small">Interested in:</span>
                    {% for project in lead.projects.all %}
                    <span class="badge bg-light text-dark border ms-1">{{ project.project_name }}</span>
                    {% endfor %}
                  </div>
                  {% endif %}
                </div>
                {% empty %}
                <div class="text-center py-5">
                  <i class="bi bi-people fs-1 text-muted opacity-25 mb-3"></i>
                  <h6 class="text-muted">No leads found</h6>
                  <p class="text-muted small mb-0">This agent doesn't have any leads yet.</p>
                </div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>

        <!-- Withdraw Tab -->
        <div class="tab-pane fade" id="withdraw" role="tabpanel">
          
          <!-- Withdrawal Summary -->
          <div class="card border-0 shadow-sm rounded-4 mb-4">
            <div class="card-body p-4">
              <h6 class="fw-semibold mb-4 text-dark">Commission Summary</h6>
              <div class="row g-3">
                <div class="col-md-4">
                  <div class="text-center p-3 rounded-3 border shadow-sm">
                    <h4 class="fw-bold text-primary mb-1">₹{{ total_commission|floatformat:0|default:"0" }}</h4>
                    <span class="text-muted small">Total Commission</span>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="text-center p-3 rounded-3 border shadow-sm">
                    <h4 class="fw-bold text-success mb-1">₹{{ available_commission|floatformat:0|default:"0" }}</h4>
                    <span class="text-muted small">Available</span>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="text-center p-3 rounded-3 border shadow-sm">
                    <h4 class="fw-bold text-info mb-1">₹{{ withdrawn_amount|floatformat:0|default:"0" }}</h4>
                    <span class="text-muted small">Withdrawn</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Withdrawal Requests -->
          <div class="card border-0 shadow-sm rounded-4">
            <div class="card-header bg-transparent border-0 py-3 px-4">
              <h6 class="fw-semibold mb-0 text-dark">Withdrawal Requests</h6>
            </div>
            <div class="card-body p-0" style="max-height: 800px; overflow-y: auto;">
              {% for withdrawal in withdrawal_requests %}
              <div class="border-bottom p-4 {% if forloop.last %}border-bottom-0{% endif %}">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <h6 class="fw-semibold text-dark mb-1">Request #{{ withdrawal.id }}</h6>
                    <p class="text-muted mb-1">
                      <i class="bi bi-calendar me-1"></i>
                      {{ withdrawal.requested_at|date:"M d, Y h:i A" }}
                    </p>
                    <span class="badge {% if withdrawal.approved %}bg-success{% else %}bg-warning{% endif %} rounded-pill">
                      {% if withdrawal.approved %}Approved{% else %}Pending{% endif %}
                    </span>
                  </div>
                  <div class="text-end">
                    <h5 class="fw-bold text-primary mb-1">₹{{ withdrawal.amount }}</h5>
                    {% if withdrawal.approved %}
                    <small class="text-muted">Approved on {{ withdrawal.approved_at|date:"M d, Y" }}</small>
                    {% endif %}
                  </div>
                </div>
              </div>
              {% empty %}
              <div class="text-center py-5">
                <i class="bi bi-cash-coin fs-1 text-muted opacity-25 mb-3"></i>
                <h6 class="text-muted">No withdrawal requests</h6>
                <p class="text-muted small mb-0">This agent hasn't made any withdrawal requests yet.</p>
              </div>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- Toastify CSS & JS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

<style>
  .icon-wrapper {
    transition: transform 0.2s ease;
  }
  
  .card:hover .icon-wrapper {
    transform: scale(1.05);
  }
  
  .lead-item:hover {
    background-color: #f8f9fa;
    transition: background-color 0.2s ease;
  }
  
  .nav-tabs .nav-link {
    border: none;
    color: #6c757d;
    font-weight: 500;
  }
  
  .nav-tabs .nav-link.active {
    color: #4e73df;
    border-bottom: 3px solid #4e73df;
    background: transparent;
  }
  
  .nav-tabs .nav-link:hover {
    color: #4e73df;
  }
  
  .card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  
  .card:hover {
    transform: translateY(-2px);
  }

  /* Custom scrollbar styling */
  .leads-container {
    scrollbar-width: thin;
    scrollbar-color: #c1c1c1 #f8f9fa;
  }

  .leads-container::-webkit-scrollbar {
    width: 6px;
  }

  .leads-container::-webkit-scrollbar-track {
    background: #f8f9fa;
    border-radius: 3px;
  }

  .leads-container::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
  }

  .leads-container::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
  }
</style>
<script>
  // CSRF token helper function
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  // Activation/Deactivation functionality
  document.addEventListener('DOMContentLoaded', function() {
    const activateBtn = document.getElementById('activateBtn');
    const deactivateBtn = document.getElementById('deactivateBtn');
    const statusBadge = document.getElementById('statusBadge');

    if (activateBtn) {
      activateBtn.addEventListener('click', function() {
        toggleAgentStatus(true, activateBtn, deactivateBtn);
      });
    }

    if (deactivateBtn) {
      deactivateBtn.addEventListener('click', function() {
        toggleAgentStatus(false, activateBtn, deactivateBtn);
      });
    }

    function toggleAgentStatus(activate, activateBtn, deactivateBtn) {
      const url = activate ? "{% url 'approve_agent' agent.id %}" : "{% url 'deactivate_agent' agent.id %}";
      const action = activate ? 'activate' : 'deactivate';
      
      if (confirm(`Are you sure you want to ${action} this agent?`)) {
        // Show loading state
        const currentBtn = activate ? activateBtn : deactivateBtn;
        const originalText = currentBtn.innerHTML;
        currentBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Processing...';
        currentBtn.disabled = true;

        fetch(url, {
          method: 'POST',
          headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
          },
        })
        .then(response => {
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          return response.json();
        })
        .then(data => {
          if (data.success) {
            // Update UI
            if (activate) {
              statusBadge.className = 'badge bg-success rounded-pill px-3 py-2';
              statusBadge.textContent = 'Active';
              if (activateBtn) activateBtn.style.display = 'none';
              if (deactivateBtn) deactivateBtn.style.display = 'block';
            } else {
              statusBadge.className = 'badge bg-danger rounded-pill px-3 py-2';
              statusBadge.textContent = 'Deactivated';
              if (deactivateBtn) deactivateBtn.style.display = 'none';
              if (activateBtn) activateBtn.style.display = 'block';
            }
            
            // Show success message
            Toastify({
              text: data.message,
              duration: 4000,
              gravity: "top",
              position: "right",
              backgroundColor: activate ? 
                "linear-gradient(to right, #00b09b, #96c93d)" : 
                "linear-gradient(to right, #ff4b1f, #ff9068)",
              className: "rounded shadow",
              stopOnFocus: true
            }).showToast();
          } else {
            throw new Error(data.message || 'Unknown error occurred');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          // Show error message
          Toastify({
            text: 'Error: ' + error.message,
            duration: 4000,
            gravity: "top",
            position: "right",
            backgroundColor: "linear-gradient(to right, #ff416c, #ff4b2b)",
            className: "rounded shadow",
            stopOnFocus: true
          }).showToast();
        })
        .finally(() => {
          // Reset button state
          currentBtn.innerHTML = originalText;
          currentBtn.disabled = false;
        });
      }
    }
  });

  // Check URL param and show toast for page load messages
  const urlParams = new URLSearchParams(window.location.search);
  if (urlParams.get("deactivated") === "1") {
    Toastify({
      text: "Agent has been deactivated successfully!",
      duration: 4000,
      gravity: "top", 
      position: "right",
      backgroundColor: "linear-gradient(to right, #ff4b1f, #ff9068)",
      className: "rounded shadow",
      stopOnFocus: true
    }).showToast();

    // Remove query param after showing toast
    const url = new URL(window.location.href);
    url.searchParams.delete("deactivated");
    window.history.replaceState({}, document.title, url.toString());
  }
  
  if (urlParams.get("activated") === "1") {
    Toastify({
      text: "Agent has been activated successfully!",
      duration: 4000,
      gravity: "top", 
      position: "right",
      backgroundColor: "linear-gradient(to right, #00b09b, #96c93d)",
      className: "rounded shadow",
      stopOnFocus: true
    }).showToast();

    // Remove query param after showing toast
    const url = new URL(window.location.href);
    url.searchParams.delete("activated");
    window.history.replaceState({}, document.title, url.toString());
  }
</script>

<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
{% endblock %}