{% extends 'admin_base.html' %}
{% load static %}
{% block content %}

<div class="container-fluid py-4 dashboard-page">

  <!-- Page Header -->
  <div class="d-flex flex-wrap justify-content-between align-items-center mb-4 gap-3">
    <div>
      <h2 class="h4 mb-1 fw-bold text-dark">Dashboard Overview</h2>
      <p class="text-muted mb-0">Monitor your real estate business performance</p>
    </div>
    <div class="d-flex gap-2">
      <button class="btn btn-outline-primary rounded-3" id="refreshBtn">
        <i class="bi bi-arrow-clockwise me-2"></i> Refresh
      </button>
     
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="row g-3 mb-4">
    <div class="col-xl-3 col-md-6">
      <div class="card stat-card h-100 border-0 shadow-sm rounded-4 projects-card">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <p class="text-muted mb-1">Total Projects</p>
              <h3 class="fw-bold mb-0" id="totalProjects">{{ projects_count }}</h3>
            </div>
            <span class="stat-icon text-primary bg-primary bg-opacity-10">
              <i class="bi bi-kanban"></i>
            </span>
          </div>
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-md-6">
      <div class="card stat-card h-100 border-0 shadow-sm rounded-4 agents-card">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <p class="text-muted mb-1">Active Agents</p>
              <h3 class="fw-bold mb-0" id="totalAgents">{{ agents_count }}</h3>
            </div>
            <span class="stat-icon text-success bg-success bg-opacity-10">
              <i class="bi bi-people"></i>
            </span>
          </div>
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-md-6">
      <div class="card stat-card h-100 border-0 shadow-sm rounded-4 leads-card">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <p class="text-muted mb-1">Total Leads</p>
              <h3 class="fw-bold mb-0" id="totalLeads">{{ leads_count }}</h3>
            </div>
            <span class="stat-icon text-info bg-info bg-opacity-10">
              <i class="bi bi-person-badge"></i>
            </span>
          </div>
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-md-6">
      <div class="card stat-card h-100 border-0 shadow-sm rounded-4 plots-card">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <p class="text-muted mb-1">Available Plots</p>
              <h3 class="fw-bold mb-0" id="totalPlots">{{ plots_count }}</h3>
            </div>
            <span class="stat-icon text-warning bg-warning bg-opacity-10">
              <i class="bi bi-map"></i>
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-4">
    <!-- Left Column -->
    <div class="col-lg-6">
      <!-- Recent Leads Card -->
      <div class="card border-0 shadow-sm rounded-4">
        <div class="card-header bg-transparent border-0 px-4 pt-4 pb-2">
          <div class="d-flex flex-wrap justify-content-between align-items-center w-100 gap-3">
            <div class="d-flex align-items-center gap-2">
              <i class="bi bi-person-badge text-primary fs-4"></i>
              <div>
                <h5 class="mb-0 fw-bold">Recent Leads</h5>
                <small class="text-muted">Latest lead activities</small>
              </div>
            </div>
            <a href="{% url 'lead_list' %}" class="btn btn-sm btn-outline-primary rounded-3">View All</a>
          </div>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive rounded-bottom-4">
            <table class="table table-hover align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th class="ps-4">Lead</th>
                  <th>Contact</th>
                  <th>Agent</th>
                  <th class="pe-4">Status</th>
                </tr>
              </thead>
              <tbody>
                {% for lead in recent_leads %}
                <tr>
                  <td class="ps-4 py-3">
                    <div class="d-flex align-items-center gap-3">
                      <div class="lead-avatar bg-primary bg-opacity-10 text-primary rounded-3">
                        <i class="bi bi-person"></i>
                      </div>
                      <div>
                        <h6 class="mb-1 fw-semibold text-dark">{{ lead.full_name }}</h6>
                        <p class="text-muted small mb-0">{{ lead.email|default:"—" }}</p>
                      </div>
                    </div>
                  </td>
                  <td class="text-muted">
                    <i class="bi bi-telephone me-1 text-primary"></i>
                    {{ lead.contact_number }}
                  </td>
                  <td>
                    <span class="text-muted small">{{ lead.agent.full_name }}</span>
                  </td>
                  <td class="pe-4">
                    {% if lead.status == 'new' %}
                    <span class="badge rounded-pill bg-primary bg-opacity-10 text-primary border border-primary border-opacity-25">
                      New
                    </span>
                    {% elif lead.status == 'contacted' %}
                    <span class="badge rounded-pill bg-info bg-opacity-10 text-info border border-info border-opacity-25">
                      Contacted
                    </span>
                    {% elif lead.status == 'qualified' %}
                    <span class="badge rounded-pill bg-success bg-opacity-10 text-success border border-success border-opacity-25">
                      Qualified
                    </span>
                    {% elif lead.status == 'lost' %}
                    <span class="badge rounded-pill bg-danger bg-opacity-10 text-danger border border-danger border-opacity-25">
                      Lost
                    </span>
                    {% else %}
                    <span class="badge rounded-pill bg-secondary bg-opacity-10 text-secondary border border-secondary border-opacity-25">
                      {{ lead.get_status_display }}
                    </span>
                    {% endif %}
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="4" class="text-center py-5 text-muted">
                    <i class="bi bi-person-x fs-1 d-block mb-3 opacity-25"></i>
                    <h5 class="text-muted">No leads found</h5>
                    <p class="mb-0">No recent lead activities.</p>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Top Performing Agents Card -->
      <div class="card border-0 shadow-sm rounded-4 mt-4">
        <div class="card-header bg-transparent border-0 px-4 pt-4 pb-2">
          <div class="d-flex flex-wrap justify-content-between align-items-center w-100 gap-3">
            <div class="d-flex align-items-center gap-2">
              <i class="bi bi-trophy text-warning fs-4"></i>
              <div>
                <h5 class="mb-0 fw-bold">Top Performing Agents</h5>
                <small class="text-muted">Based on total commission</small>
              </div>
            </div>
            <a href="{% url 'agents_list' %}" class="btn btn-sm btn-outline-warning rounded-3">View All</a>
          </div>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive rounded-bottom-4">
            <table class="table table-hover align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th class="ps-4">Agent</th>
                  <th>Email</th>
                  <th class="pe-4 text-end">Total Commission</th>
                </tr>
              </thead>
              <tbody>
                {% for agent in top_agents %}
                <tr>
                  <td class="ps-4 py-3">
                    <div class="d-flex align-items-center gap-3">
                      <div class="agent-avatar bg-warning bg-opacity-10 text-warning rounded-3">
                        <i class="bi bi-person-check"></i>
                      </div>
                      <div>
                        <h6 class="mb-1 fw-semibold text-dark">{{ agent.full_name }}</h6>
                        <p class="text-muted small mb-0">Active</p>
                      </div>
                    </div>
                  </td>
                  <td class="text-muted">{{ agent.email }}</td>
                  <td class="pe-4 text-end">
                    <span class="fw-bold text-success">₹{{ agent.total_commission_sum|default:0 }}</span>
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="3" class="text-center py-5 text-muted">
                    <i class="bi bi-trophy fs-1 d-block mb-3 opacity-25"></i>
                    <h5 class="text-muted">No data available</h5>
                    <p class="mb-0">No commission data found.</p>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Column -->
    <div class="col-lg-6">
      <!-- Recent Agents Card -->
      <div class="card border-0 shadow-sm rounded-4">
        <div class="card-header bg-transparent border-0 px-4 pt-4 pb-2">
          <div class="d-flex flex-wrap justify-content-between align-items-center w-100 gap-3">
            <div class="d-flex align-items-center gap-2">
              <i class="bi bi-people text-success fs-4"></i>
              <div>
                <h5 class="mb-0 fw-bold">Recent Agents</h5>
                <small class="text-muted">Newly registered agents</small>
              </div>
            </div>
            <a href="{% url 'agents_list' %}" class="btn btn-sm btn-outline-success rounded-3">View All</a>
          </div>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive rounded-bottom-4">
            <table class="table table-hover align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th class="ps-4">Agent</th>
                  <th>Email</th>
                  <th>Phone</th>
                  <th class="pe-4">Status</th>
                </tr>
              </thead>
              <tbody>
                {% for user in recent_agents %}
                <tr>
                  <td class="ps-4 py-3">
                    <div class="d-flex align-items-center gap-3">
                      <div class="agent-avatar bg-success bg-opacity-10 text-success rounded-3">
                        <i class="bi bi-person-plus"></i>
                      </div>
                      <div>
                        <h6 class="mb-1 fw-semibold text-dark">{{ user.full_name }}</h6>
                      </div>
                    </div>
                  </td>
                  <td class="text-muted">{{ user.email }}</td>
                  <td class="text-muted">{{ user.phone_number|default:"—" }}</td>
                  <td class="pe-4">
                    {% if user.approved %}
                    <span class="badge rounded-pill bg-success bg-opacity-10 text-success border border-success border-opacity-25">
                      Approved
                    </span>
                    {% else %}
                    <span class="badge rounded-pill bg-warning bg-opacity-10 text-warning border border-warning border-opacity-25">
                      Pending
                    </span>
                    {% endif %}
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="4" class="text-center py-5 text-muted">
                    <i class="bi bi-people fs-1 d-block mb-3 opacity-25"></i>
                    <h5 class="text-muted">No agents found</h5>
                    <p class="mb-0">No recent agent registrations.</p>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Recent Projects Card -->
      <div class="card border-0 shadow-sm rounded-4 mt-4">
        <div class="card-header bg-transparent border-0 px-4 pt-4 pb-2">
          <div class="d-flex flex-wrap justify-content-between align-items-center w-100 gap-3">
            <div class="d-flex align-items-center gap-2">
              <i class="bi bi-kanban text-info fs-4"></i>
              <div>
                <h5 class="mb-0 fw-bold">Recent Projects</h5>
                <small class="text-muted">Latest project additions</small>
              </div>
            </div>
            <a href="{% url 'projects' %}" class="btn btn-sm btn-outline-info rounded-3">View All</a>
          </div>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive rounded-bottom-4">
            <table class="table table-hover align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th class="ps-4">Project</th>
                  <th>Location</th>
                  <th>Plots</th>
                  <th class="pe-4">Commission</th>
                </tr>
              </thead>
              <tbody>
                {% for project in recent_projects %}
                <tr>
                  <td class="ps-4 py-3">
                    <div class="d-flex align-items-center gap-3">
                      <div class="project-avatar bg-info bg-opacity-10 text-info rounded-3">
                        <i class="bi bi-building"></i>
                      </div>
                      <div>
                        <h6 class="mb-1 fw-semibold text-dark">{{ project.project_name }}</h6>
                        <p class="text-muted small mb-0">{{ project.project_type|default:"—" }}</p>
                      </div>
                    </div>
                  </td>
                  <td class="text-muted">
                    <i class="bi bi-geo-alt me-1 text-primary"></i>
                    {{ project.location|default:"—" }}
                  </td>
                  <td class="fw-semibold">{{ project.total_plots|default:"—" }}</td>
                  <td class="pe-4">
                    <span class="fw-bold text-warning">{{ project.commission_percentage|default:"—" }}%</span>
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="4" class="text-center py-5 text-muted">
                    <i class="bi bi-kanban fs-1 d-block mb-3 opacity-25"></i>
                    <h5 class="text-muted">No projects found</h5>
                    <p class="mb-0">No recent project additions.</p>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

<style>
.dashboard-page .stat-card {
  transition: transform 0.2s ease, box-shadow 0.2s ease;
  background: #ffffff;
}
.dashboard-page .projects-card {
  background: linear-gradient(135deg, #eef2ff, #e0ecff);
}
.dashboard-page .agents-card {
  background: linear-gradient(135deg, #e8fdf4, #d3f8e5);
}
.dashboard-page .leads-card {
  background: linear-gradient(135deg, #e6f7ff, #d8f0ff);
}
.dashboard-page .plots-card {
  background: linear-gradient(135deg, #fff7e5, #ffeccc);
}
.dashboard-page .stat-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 25px rgba(0,0,0,0.1) !important;
}
.dashboard-page .stat-icon {
  width: 48px;
  height: 48px;
  border-radius: 16px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-size: 1.4rem;
}
.dashboard-page .lead-avatar,
.dashboard-page .agent-avatar,
.dashboard-page .project-avatar {
  width: 44px;
  height: 44px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-size: 1.15rem;
}
.dashboard-page .table tbody tr {
  transition: background-color 0.2s ease, transform 0.2s ease;
}
.dashboard-page .table tbody tr:hover {
  background-color: rgba(78, 115, 223, 0.05);
  transform: translateY(-1px);
}
.dashboard-page .card {
  transition: transform 0.2s ease;
}
.dashboard-page .card:hover {
  transform: translateY(-2px);
}
.rounded-bottom-4 {
  border-bottom-left-radius: 1rem !important;
  border-bottom-right-radius: 1rem !important;
}

/* Remove extra space and fix agent name alignment */
.dashboard-page .card {
  margin-bottom: 0;
}
.dashboard-page .table td {
  padding: 0.75rem;
  vertical-align: middle;
}
.dashboard-page .table th {
  padding: 0.75rem;
  white-space: nowrap;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Refresh button functionality
  document.getElementById('refreshBtn').addEventListener('click', function() {
    const btn = this;
    const originalHtml = btn.innerHTML;
    btn.innerHTML = '<i class="bi bi-arrow-clockwise me-2 spin"></i> Refreshing...';
    btn.disabled = true;
    
    setTimeout(() => {
      location.reload();
    }, 1000);
  });



  // Add spin animation
  const style = document.createElement('style');
  style.textContent = `
    .spin {
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
  `;
  document.head.appendChild(style);
});
</script>

{% endblock %}